## 自适应量化

一种利用感知对比度掩蔽现象的帧内分块码率调整，将更多码率分配到“更重要”地方的方法。

![VAQ Source](files/rate-control/VAQ-Source3.webp) ![VAQ Mode1 Map](files/rate-control/VAQ-Source3-Mode1.png) ![VAQ Mode1 Map](files/rate-control/VAQ-Source3-Mode1-Stat.png)

图：简单根据纹理（Mode 1）分布/密度增减量化值；来源及更多图例：[Github/Khrysoberyl](https://github.com/Khrysoberyl/vs_AQVisualizer)

### 感知对比度掩蔽现象（Perceptual contrast masking）

注：这不是摄影后期/PhotoShop 的对比度遮罩处理法（Contrast Masking）

自然界中的动物通过打乱自身外形的线条轮廓，从而在不调整自身颜色，不改变体温，不变更习性，不妥协体型大小的情况下做到的外形伪装。这种效应的参数包括：

- 空间距离差异——两种特征的距离越近，掩蔽越强
- 特征差异——两种特征的摆放角度，空间频率越接近，掩蔽越强
- 对比度差异——两种特征的对比度越大，掩蔽越强

这种现象说明不只是音量，颜色或亮度的差异能掩蔽内容，单纯是画面中细节的分布不同就可以让人视而不见——*空间频率高，纹理复杂的内容能够掩蔽频率低，纹理简单的内容*，只要找出这些信息，就有机会进行更强力的有损压缩了。

具体来说，自适应量化利用了这一效应来重新分配不同分块的量化强度，具体到*量化失真处的像素值变化程度不大于纹理像素值变化的程度即可*。

要注意的是，尽管该方法常用，但对比度感知现象的原理尚不明确——如果观众仔细看就会发现失真。因此这也是“高播放画质”与“高暂停画质”的区别之一。

### 方差（Variance）

表示数据样本相对于整体平均值的离散程度。有时平均值，包括加权平均值指标并不可靠，或者说我们需要知道平均值到底有多可靠。因此有了这种“差→方→和→均”式计算，即“以偏差之和窥数据之衡”。

\\\[ \sigma^{2}=\frac{\sum\_{i=1}^{N} (x\_{i}-\overline{x})^{2}}{N} \\]

1. **差：**&#x6BCF;个数据样本减去整体平均值，得到各个差值（距离）
2. **方：**&#x5404;个差值逐一取平方以放大误差，顺便使得各个差值被绝对值化
   - 在此处同样可以直接取绝对值而取平方，但这样做会失去微分兼容性，且极端值的影响更难体现出来
3. **和：**&#x5E73;方后的值求和，得到整体的平方误差/二维误差
4. **均：**&#x9664;以样本数的平均计算，得到方差

\\\[ \text{Variance} = \frac{\text{SSE}\_{Pixels\_{Macroblock}} - (\text{SAD}\_{Macroblock})^2}{Pixels\_{Macroblock}} = \frac{\text{SSE}\_{Pixels\_{Macroblock}} - (\text{SAD}\_{Macroblock})^2}{256} \\]

![VAQ Source](files/rate-control/Variance-Visualization.png)

图：实际上，“取平方”在视觉上也更加合理，例如这个 GPU 渲染流程中，上半部分使用柱状图，下半部分相同但取了平方，使得时间维度的影响偏差（视觉面积）一目了然；来源：[YouTube/Threat Interactive](https://www.youtube.com/watch?v=0njXa-OknIs)

`--aq-mode`

<整数 0\~3>据原画和 CRF/ABR 强度设定，码率不足时分配细分块量化强度的策略

- 1普通自适应量化，适用于简单平面以及快速编码场景
- 2方差自适应量化，同时自动调整 `--aq-strength` 的强度。推荐用于录像电影，或搭配 CRF 小于 17，高码率 ABR 等不会欠码的策略
- 3在欠码时倾向保暗场画质
- 4在欠码时更加倾向保纹理画质（接受平面涂抹失真，动漫和幻灯片录屏场景慎用）

`--aq-strength`

<浮点>自适应量化强度，推荐搭配 `--aq-mode` 使用。如动漫和幻灯片录屏等平面多过纹理的场景下 `--aq-mode 1 --aq-strength 0.8`, 2:0.9，3:0.7

- 录像或更复杂上如果不愿降低 CRF/增加 ABR 码率，则额外增加 0.1\~0.2
- 注意低成本动漫和幻灯片录屏等平面多过纹理的画面，因此码率不足时反而要更改量化强度分配策略为妥协纹理
