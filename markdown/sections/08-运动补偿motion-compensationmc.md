## 运动补偿（Motion Compensation、MC）

整数像素动态搜索虽看起来很准，但精度终归有限，只能算是“粗加工预测”；直接使用整数动态向量会导致纹理细节和物件边缘信息的丢失。为此，编码器需要对向量“精加工”——对齐到插值出的 half-pixel（hpel）/ ½ 像素，以及 quarter-pixel（qpel）/ ¼ 像素，使预测画面（指 PU、PB）的残差变小，与输入源画面更一致。

注：虽然看起来只有一个子像素补偿，但这不妨碍运动补偿作为一个完整独立的步骤存在。此外，在 AV1 标准中，运动补偿就不只有一种了。

### 整数像素运动补偿

视频编码中同动态搜索（ME）。

### 子像素运动补偿（Subpixel Motion Compensation）

1. 线性插值参考帧（有限冲击响应滤镜 FIR），分别生成上采样/放大 2x 和 4x 的副本

2. 以整数向量落点为起点搜索放大副本的位置，从而找出率失真代价最小的子像素动态向量位置：

   - **(J)oule**：率失真代价（RD Cost），失真最小的候选最精确
   - **(D)istortion**：使用当前子像素动态向量编码预测块与输入源画面的差异（SATD）
   - **(R)ate**：计算编码这些新向量所产生的码率
   - **λ**：拉格朗日代价

注：率失真优化计算见下方版块的说明。

![Block-Spitting-Stage-Two](files/mpmemc/Block-Spitting-Stage-Two.png)

图：根据动态搜索与补偿所得，完成宏块到块的细分

| 编码器（官方） | 平面——块类型 | 范围精度       | 插值方法           |
| ------- | ------- | ---------- | -------------- |
| x264    | 亮度 Y    | ½ 像素（hpel） | 6 tap FIR      |
| x264    | 亮度 Y    | ¼ 像素（qpel） | 双线性插值（Bi-lerp） |
| x264    | 色度 C    | hpel+qpel  | 上下左右加权平均       |
| x265    | 亮度 Y    | hpel+qpel  | 上下左右加权平均       |
| x265    | 亮度 Y    | ¼像素（qpel）  | 两种 7tap FIR    |
| x265    | 色度 C    | hpel+qpel  | 4tap FIR       |

表：x264/5 的 hpel\~qpel FIR 插值放大算法使用。x264 使用 6tap FIR 滤镜，x265 使用 8tap、7tap 和 4tap FIR 滤镜。

![hpel qpel interpolation](files/mpmemc/hpel-qpel-interpolation-v2.svg)

`--subme`

<整数 1\~10，推荐 6\~10>调整具体的动态补偿强度，x264 中同时决定模式决策和率失真优化的强度。根据画质和编码速度选择合适的大小：

- 1 逐块 1/4 像素使用 SAD 算法检验一种对齐
- 2 逐块 1/4 像素 SATD 算法检验两种对齐
- 3 逐宏块 1/2 像素 SATD 一次，逐块 1/4 像素 SATD 一次
- 4 逐宏块 1/4 像素 SATD 一次，逐块 1/4 像素 SATD 一次
- 5 同时增加双向参考 B 块
- 6 同时 I，P 帧启用率失真优化处理
- 7 同时 I，P，B，b 帧启用率失真优化处理
- 8 同时 I，P 帧启用 `rd-refine` 功能
- 9 同时 I，P，B，b 帧启用 `rd-refine` 功能
- 10 使用 `--me hex` 动态搜索检验对齐，需 `--trellis 2 --aq-strength > 0`
- 11 关闭所有提前退出，边际效应过大，不推荐使用

`rd-refine`（内部参数）

<嵌入 `--subme 8` 中，x265 中可手动打开> 率失真优化分析帧内预测的最佳量化和分块结果，耗时换压缩率和画质。x264 中还包括了最优动态向量的分析

### 细分块

`--partitions`

<字符串 `p8x8`，`p4x4`，`b8x8`，`i8x8`，`i4x4/none/all`，默认 `p8x8`，`b8x8`，`i8x8`，`i4x4`，推荐 `all`>允许的细分块种类。增加分块种类会增加计算负载，但对现在的 6\~16 核消费级 CPU 来说无咎。因此推荐 all

- 开启 p8x8 会同时启用 p16x8，p8x16
- 开启 p4x4 会同时启用 p8x4，p4x8
- 开启 b8x8 会同时启用 b16x8，b8x16
- 因为 [边际效益太小](https://forum.doom9.org/showthread.php?t=125734)，x264 开发者取消了 b4x4 分块
