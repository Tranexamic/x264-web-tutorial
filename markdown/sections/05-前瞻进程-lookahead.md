## 前瞻进程 Lookahead

最先启动，设立关键帧和参考帧，决定了 GOP 划分、帧类型推演、转场设立、逐帧量化强度等多项初始数据。

视频编码的前瞻进程涉及多个复杂步骤，因此并无直观的图解；不过尽管原理不同，前瞻型纯追踪算法 Pure pursuit lookahead 有着一致的“让程序变聪明”概念，并解释了前瞻进程长度对精度的影响：

![Pure Pursuit Lookahead](files/Pure_Pursuit_Lookahead.png)

图：前瞻型纯追踪算法 Pure pursuit lookahead。见[MatLab](https://www.mathworks.com/help/nav/ug/pure-pursuit-controller.html)

前瞻进程距离短时，计算容易出现过冲（Overshoot）现象；距离长则虽然判断稳定，但程序占用的缓存更多，延迟也往往更大。

`--keyint`

<整数，默认 250，推荐 9\~12 倍帧率（即 9\~12 秒）>指定最长关键帧间隔（GOP 长度）。当距离上一个 IDR 帧达到阈值时，覆盖帧类型推演而直接设立 IDR 帧，开始一个新 GOP，并弃用 IDR 帧前的所有数据。

- 如果视频用于多轨剪辑素材（且频繁拖动进度条），则建议 6\~8 倍帧率（即 6\~8 秒）以降低解码器负载，提高流畅度

`--min-keyint`

<整数，默认 25>指定最小关键帧（IDR 帧）间隔。当转场判断（scenecut）被触发时，这个间隔之内的设立为 I 帧，之外的设立为 IDR 帧。非关键帧的 I 帧虽然也是独立图像，但不刷新解码器缓冲区，因此帧间参考会继续。有两种设定逻辑，而它们给出的画质都一样，区别在于体积：

- keyint÷2 \~ keyint：设立新 I 帧意味着一批帧内编码任务被设立，而设立 IDR 帧还要重新开始帧间编码，不急着设立 IDR 帧虽然对压缩/画质不好，但也不容易在录制时卡顿
- 1：一帧被判为 I 帧，而不是 P、B 帧，已经说明了说明前后并不适合参考。因此即使两帧挨得很近，也有可能是两个不同的场景，于是设立 IDR 帧拆分成 GOP 是画质最好，但帧间参考最差的选项。
- 5\~10：相比 1 在 24\~60 fps 帧率下略微放宽要求（约 0.1\~.15 秒），避免画面闪烁、闪回插入镜头（如意识流蒙太奇剪辑）时 IDR 帧数暴涨，维持帧间参考；推荐搭配 `--gop-lookahead` 使用

`--ref`

<整数 1\~16>多参考帧前后帧数半径，一图流设 1。必须要在溯全尽可能多块的情况下降低参考长度，所以推荐 3：

`--no-mixed-refs`

<开关>关闭参考帧混合溯块（16×8，8×8 分块的参考）以提速，增加误参考。不推荐

`--scenecut`

<整数，不推荐用>Lookahead 中两帧差距达到该参数值则触发转场

`--seek`

<整数，默认 0>从第几帧开始压缩

`--frames`

<整数，默认全部>一共压缩多少帧

`--fps`

<整数或除法，自动开启 `--force-cfr`>设定输出视频帧率，除非有指定的必要（如源视频为 RAW YUV 或帧率错误），否则无需配置。

`--force-cfr`

<开关>强制设定视频帧到整数时间码，可能用于对齐小数帧率的误差（如 23.976 或 24000/1001 变成 23.977）用

`--fullrange`

<开关，7mod x264 自动>启用 0\~255 色彩范围，而不是默认的 16\~235。视频内容永远不在使用有限色域设备/软件/视频网站下播放下可以考虑开启
