## 优化熵编码

### 残差 DCT 系子

Residual DCT coefficients 代表变换后量化前，已知经过量化后会被抹除的 DCT 系子。DCT 变换的例子见本教程的 [变换——DCT 变换](#h2-7) 部分。总之就是与“残差块”无关，只是都叫做残差而已。

### 编码块标记 CBF

Coded block flag 会被标在预测和/或与其相应的变换单元（亮度块加色度块）中表示该单元是否附有较多的残差系子：CBF=1 代表有、0 代表没有。引导四叉树 quadtree 算法进一步分枝——宏块向下分块。详见 [US9749645B2](https://patents.google.com/patent/US9749645B2/en)。

![Quad-tree-bitmap](files/entropy-coding-optimization/Quad-tree-bitmap.svg)

图：四叉树的分块。见[维基百科](https://en.wikipedia.org/wiki/Quadtree)

### DCT 归零优化 Decimate

由上可知，录像与电影片源中的动态噪点会直接干扰编码器的分块，导致熵编码总是要处理系子数量少的 8x8，4x4 分块，而 x264 设计时面向了 640x480 分辨率的视频，所以就有了专门用于避免无效分块，避免性能和熵编码压缩率被浪费的系子归零处理（现已淘汰但默认开启）。具体是：

1. 8x8 亮度块中分量为 -3\~3 的 DCT 系子归零
2. 16x16 亮度块中分量为 -5\~5 的 DCT 系子归零
3. 色度块中分量为 -6\~6 的 DCT 系子归零
4. 优化后的块回到原来的编码步骤——量化中

`--no-dct-decimate`

<开关，默认关>关闭 DCT 变换的低强度系子归零操作，以减少细节损失，降低有损压缩。适合幻灯片录屏等画面极其干净，或经过大量滤镜过滤噪声，`--crf < 17`或 ABR `--bitrate > 500000` 编码策略的源视频

### 死区量化器 Dead-zone Quantizer 优化

死区，也叫 dead-band，netual-zone，或无作用区，代表输入到输出波形中可归零的部分。

![Deadband-operator](files/entropy-coding-optimization/Deadband-operator.svg)

图：信号死区设 0.5 时，输入到输出 y=x 波形的变化。见[维基百科](https://en.wikipedia.org/wiki/Deadband)

死区量化器的用途同上。x264 中，`--trellis`没有完全开启（2）时，死区量化器会被替代启用。默认设置下：

1. 帧间亮度块中，分量为 -21\~21 的 DCT 系子归零
2. 帧内亮度块中，分量为 -11\~11 的 DCT 系子归零
3. 优化后的块回到原来的编码步骤——量化中

因此，结果是在高分辨率下，默认设置对画面细节的涂抹较强，所以一般建议 `--trellis 2`，或在最少大于等于 1600x900 分辨率、`--trellis < 2` 的时候更改死区量化器相关参数的默认值。

`--deadzone-inter`

<整数 0\~32，默认 21，`--trellis` 小于 2 时开启>一种逻辑简单的帧间再量化——细节面积小于死区就删掉，大就保留。一般用途建议 8，高画质建议 6

`--deadzone-intra`

<整数 0\~32，默认 11，`--trellis` 小于 2 时开启>一种逻辑简单的帧间再量化——细节面积小于死区就删掉，大就保留。一般用途建议 8，高画质建议 4

### 软判决率失真游程走线优化——SDQ trellis

Soft decision quantization / SDQ trellis 算法。通过限制量化后块中的 DCT 系子 coefficients 强度，甚至偏移当前系子的强度值到临近系子，以保证游程编码中走线的平稳。过程中由率失真计算确认对画面的影响符合预期质量，从而提高压缩率。`--trellis` 应用于量化步骤之后，并且对少数突兀的 DCT 系子强度做了平均化，所以叫“再量化”。详见 [](../../x265-web-tutorial/HTML/index.html#h2-16)x265 教程——优化熵编码

`--trellis`

<整数，范围 0\~2, 推荐 2>软判决优化 CABAC 的率失真再量化。

- 1调整模式决策 mode decision 处理完的块，快速压制用
- 2同时调整帧内帧间参考和分块完成的块，效果最好
