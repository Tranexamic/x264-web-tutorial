## 模式决策、环路滤镜

由于 AVC x264 的环路滤镜步骤中只有去块，所以准确的说就是“去块失真滤镜/去块滤镜（Deblock）”。之所以称作“环路/Loop”是因为编码器会在这之后进行模式决策（Mode Decision）来检查编码选用的帧内、帧间模式是否合理，于是，概念图中就出现了一条走向“倒过来回到动态搜索步骤结束为止”之后的“环路”路径，而这条路径上恰好有去块滤镜。当然，在更先进的视频编码上还有更多可用的滤镜，因此称为“滤镜组”。

环路滤镜的效果作用于重建帧（编码结果）上——成为未来帧的参考。模式决策（帧内模式、运动矢量、块划分等）都在编码当前块时完成，不会在环路滤镜处理之后再复查和修改。但编码器在决策时通常会基于“滤镜处理后的参考帧”来进行运动估计和预测，以保证和解码端一致。模式决策对于帧内编码的块/帧尤其重要，因为帧内预测的模式是根据重建（并滤波）后的左侧、左上和顶部相邻像素做的（信息有限），因此很可能还有更好的编码模式可取。对于帧间编码的块，其前后的参考帧已经进行过滤镜处理（因为编解码顺序不同于播放顺序），因此编码器可以安全地根据处理后的参考帧复查动态向量。

1. **整合动态搜索与补偿可能性**：
   - 计算并收集每种帧内，帧间预测模式的率失真分数（见下方说明）
2. **整合分块参考量化可能性**：
   - 计算并收集每种细分块方案（4x4，8x8，16x16），参考帧长度，量化强度下的率失真分数
3. **压缩方案定制**：
   - 选择码率最小的压缩方案并不是最优解，因此找出率失真分数最高的方案集，得到码率与画质最为平衡的方案

### 去块滤镜

修复“CRF/ABR 模式在某些场景的部分区域里分配量化值过高时，宏块间出现明显横纵割痕瑕疵”的平滑滤镜。编码器内去块利用了帧内帧间搜索到的信息，而理论上相比外部滤镜误判更少（当然外部滤镜也能做动态和帧内搜索）。去块大体上是检查 1 像素宽，且此块边缘没有较大像素值变化造成的横纵边缘（所以也存在误判）。块失真源自块间不统一的量化程度，有的块量化高流就会从邻近画面里凸现出来。而去块手段是平滑滤镜，因此要降低强度才适用于高码视频，动漫，素材录屏等锐利画面。边界强度 Boundary strength（去块力度判断）

![Deblock-detection-visualization](files/deblocking/Deblock-detection-visualization.png) ![Deblock-edge-visualization](files/deblocking/Deblock-edge-visualization.png)

图：取最小 8x8 范围（两个 4x4 分块）间的界线举例。

- 平滑 4：a 与 1 皆为帧内块，且边界位于 CTU/宏块间，最强滤镜值
- 平滑 3：a 或 1 皆为帧内块，但边界不在 CTU/宏块间
- 平滑 2：a 与 1 皆非帧内块，含一参考源/已编码系子
- 平滑 1：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯异帧或动态向量相异
- 平滑 0：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯同帧或动态向量相同，滤镜关

`--deblock`

<浮点偏移值，默认 1:0。推荐 0:0，-1:-1，-2:-1> 平滑强度：搜索精度。两值于原有强度上增减。

- 平滑≥1时用以压缩
- 平滑-2\~-1时略降锐度，适合串流
- 平滑2适合锐利视频源，4k 电影，游戏录屏。提高码率且会出现块失真
- 平滑-3\~-2适合高码动画源/桌面录屏。增块失真，但观感仍比 1 好
- 搜索大于 2易误判；小于 1会遗漏。建议保持0\~-1，除非量化强度大于 26 时设设1
