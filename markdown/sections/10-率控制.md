## 率控制

有损压缩中，码率分配本身会决定压缩视频的画质。这是因为参考帧 P、B 帧自身的主要信息来自于被参考帧 I 帧，其中被冗余的宏块只储存“相对于被参考帧的动态向量”，和“残差画面”。这种画面并不锐利，因而（在熵编码后的）体积占比非常小。而尽管被参考帧 I 帧的体积很大，但 I 帧自身的画面为其后的若干至数百帧提供了参考，使得高画质的 I 帧反而提高了帧间冗余压缩率（与使用 10bit 位深后，码率不增反降的原因相同）。假如被参考帧 I 帧的有损压缩较高，那么在环路滤镜组/率失真优化过程中，编码器会发现 I 帧与 P、B 帧之间不太相像；便会提高残差画面的信息量。于是虽然峰值码率会降低，但 I 帧后的一系列帧都会比以往大一些，造成整体的码率/文件体积上升。在这个基础上：

- 如果视频本身的画面变化偏大，那么参考帧 P、B 帧一开始就会储存更多的残差信息
- 如果一开始就要求限制峰值码率，那么即使文件体积增加，码率提高也是没办法的事
- 如果一开始就要求固定文件体积大小（不超过某个程度），那么原本的“码率提高”就会完全变成“画质降低”

![hyouka-frame-distro](files/rate-control/hyouka-frame-distro.webp)

图：这段 1920x1080 视频约有 36000 帧，其中 I 帧占 1%。从趋势线可以看出平均每帧的大小位于 200Kb 以下（很多都在 10b 以下）。2000Kb 以上的帧零散存在，中心还有一张 9544 Kb（1.2MB）的帧。

![solevante-frame-distro](files/rate-control/solevante-frame-distro.webp)

图：这段场景动态复杂的 3840x2160 视频约有 6000 帧，除了 I 帧的尖峰以外，出现了整块隆起的码率分布，左侧的复杂部分达到了 6\~10Mbps。

### 视频编码不可能三角

一般情况下，用户希望在可接受的编码速度（fps 为单位）下，得到画质较高、文件体积较小的视频，构成了压制的不可能三角。

![Encoding-Trade-off-Triangle](files/basics/Encoding-Trade-off-Triangle.png)

图：三种出发点构成。其“完美中心点”不一定符合当下需求，但决定了是否能满足所有情况

![rate-control-mode-selection](files/rate-control/rate-control-mode-selection.png)

图：不同率控制模式权衡编码速度，画质，文件体积的能力不同，当然有的模式根本没得选

“码率分布成因”中说明了在画质高度一致时，逐帧的码率变化非常大，在网络播放时可能会因为峰值而卡顿；反过来倘若要限制码率变化/波动，则画质的一致性便会下降（或文件体积增加）。于是在选择率控制模式时，要在“两个一致”之间妥协。

“不可能三角”中说明了在速度、画质和文件体积三者此消彼长，虽然大多情况下选择兼顾三者的中心点即可，但也需要根据不同场景的要求加以偏置

### 率控制模式

#### 平均码率模式（Average Bitrate、ABR）

- 设定统一的“平均每帧大小”（以码率每秒 / Kbps 统计）
- 编码器会根据目标平均码率和剩余帧数，粗略估算每帧可用的码率预算，只要这个平均值不超过用户设定的平均码率，就按照现有逻辑（MEMC、帧类型、块大小）设定每帧的量化强度
- P、B 帧由于运动矢量等信息依赖其他帧，通常量化强度可以更高，体积更小
- I 帧则要独立编码，体积较大，如码率紧张，I 帧可能需要更强量化（画质下降更明显）

##### ABR 模式优缺点

- 思路简单快速
- 适合直播场景
- 编码器编码 GOP 前半部分时照此操作无妨，但到了后面，若画面突然开始变化，那么当前码率会立刻上升到设定的平均码率上限，此时只能分配更强的量化强度的“码率分配不匀问题”
- 如果用户设定的码率太低，ABR 模式会设立强量化
- 如果强量化不够还会启用一些滤镜，导致画面损失太严重，无法辨认内容
- 如果用户设定的码率大于等于如 CRF、2pass 模式，则仍可能遇到“码率分配不匀问题”

#### 全局/固定量化强度模式 Constant Quantizer

- 跳过量化强度自适应算法，直接由用户指定 I、P、B（等）帧各自的量化强度

##### CQP 模式优缺点

- 速度最快
- 可以通过设定最小量化值的方法跳过量化，实现一种无损压缩模式
- 码率分配不匀问题最严重，码率与文件体积体积不易预测

#### 质量呼应码率模式（Constant Rate Factor、CRF）

- 在设定量化强度指标（CRF 参数值）的基础上，允许编码器根据当前画面的特性与帧类型进一步优化每帧的量化强度分配
- 若 CRF 值较低，而当前帧可以使用较高的量化压缩强度（如参考帧 P、B 帧）时，编码器会提高量化强度；这样不但文件体积缩小，损失的画质也肉眼难辨
- CRF 值越大，最终画质越差、码率越低；这样码率的分配仍然会是均匀的极优解

##### CRF 模式优缺点

- 同码率下的压缩率、画质最好，最适合用于分享和收藏高质量小体积视频素材
- 在要求实时编码的场景中可能会因为编码 I 帧考虑太多、用时过长、导致延迟丢帧
- 调整 CRF 和 CQP 模式不能直接控制文件体积，尽管这是因为“视频在这个质量下，只能压缩到这个程度”，但有时会导致用户不理解
- 在严格要求视频体积的场景中，如微信等平台会因为文件体积限制而不便于分享
  - 尽管这种情况下应该用技术更先进的编码器，但因为用户、平台、手机厂商的多方因素，所以导致了视频打不开的兼容性问题

#### 恒定码率模式（Constant Bitrate、CBR）、可变码率模式/灵活码率模式（Variable Bitrate、VBR）

- 在 ABR 或 CRF 模式的基础上启用码率缓冲区（Video Buffer Verifier、VBV）控制得到
- CRF 模式本质上属于半个 VBR 模式，ABR 模式本质上属于半个 CBR 模式；两者都依赖 VBV 限制码率峰值
- 当码率超过用户指定的 VBV 上限，则编码器自动增大量化强度，以防溢出
- I 帧后的一系列帧都会比以往大一些，造成整体的码率/文件体积上升，峰值下降
- 如果整体码率上升触发 ABR 限制，则进一步增加量化强度，画质下降，换来带宽控制，得到变化更平稳的码率分布

##### CBR、VBR 模式优缺点

- 可以解决峰值码率过大的问题
- 代价是整体文件体积提升（VBR），或者整体画质下降（CBR）
- 使得 CRF、ABR 模式能够更好地胜任直播、串流（外网网络播放）场景

#### 两遍模式 2pass

- Pass 1：运行 CRF 或 ABR 模式，得出每帧的量化强度，从而得出码率分配统计
- Pass 2：运行 ABR 模式，利用第一遍采集的码率分布，事先完成所有帧的码率预分配，从而精准控制文件体积
- 尽管不同的编码器对 2pass 模式的实现有差异，但基本流程与此处一致

##### 2pass 模式优缺点

- 解决了 ABR 模式在 GOP 前后码率分配不匀的问题
- 码率分配不匀的问题被弱化，只要最终码率类似，2pass 就能做到相当于 CRF 同码率的均匀度
- 能够精准控制文件体积（目标体积 ÷ 视频时长 = 目标码率），适用于硬性要求视频体积，还要考虑编码兼容性的场景
  - 例如，一个聊天平台限制上传文件不可以超过 200MB，就是一种硬性体积要求
- Pass 2 与 Pass 1 的帧类型分布（绝大多情况下）必须完全一致，所以如转场、关键帧、前瞻进程等设置需要更改时只能重做 Pass 1
- 如果要使用高压缩，则必须在 Pass 1 就使用速度较慢动态搜索与补偿，从而使得整个流程下来的编码用时远超其他模式
- 流程复杂，故障点（Point of failure）最多，操作相对困难

### 常见的误解误区

1. “我有硬性视频体积要求。我希望在保证一定画质的同时，将体积缩小一点，所以应该使用 2pass 模式”

   - 需求类型错误，“文件不得超过 200 MB”才是真正的硬性需求
   - “保证一定视频质量的同时，将体积缩的小一点”是 CRF 模式所针对的需求

2. “我希望控制体积和码率，画质可以差些，但不能一会清晰一会糊，所以应该使用 CBR 模式”

   - CBR 模式保证的是码率变化的一致性，但视频内容是变化的，因此使用 CBR 模式必然一会清晰一会糊
   - CRF 模式的“CRF 值”能保证画质的一致性，应该使用 CRF 模式

3. “我的视频要上传到视频平台，上面说达到多少平均码率后可以免二压，所以应该使用 2pass 模式”
   - 所谓的免二压规则早已绝迹，视频平台一律压缩上传的视频，除非是个人搭建的网站

`--ipratio --pbratio`

<浮点，默认 1.4、默认 1.3>P 帧相比 IDR/i 帧，以及 B/b 帧相比 P 帧的质量偏移。默认预设是给录像视频片源用的。

- 低成本动漫/多静态画面/PPT 录屏画面：各降低 0.2
- 剪辑素材：提高 --crf，不用改这两个参数
- YCbCr 4:4:4 片源：x264 默认会自动修改 --chroma-qp-offset，不用改这两个参数

`--bframes`

<整数 0\~16>最多可连续插入的双向参考帧 B 帧数量（超过后插入 P 帧）：

- 一般录像/录屏快速，以及视频剪辑素材设3\~6以防止录制和剪辑的解码算力要求过高
- 电影片源快速设8左右
- 低成本动画片源，或播放设备配置或硬解兼容高的话可设在13左右

注：`--bframes > 8`，同时 `--keyint > 250` 会根据视频分辨率而显著增加内存占用。

#### CRF 模式

质量呼应码率模式，统称 CRF。在压制的不可能三角中实现“体积与画质优先，忽略速度”的率控制模式，也是追求画质优先的唯一模式（码率受限则画质不如 2pass 模式均衡）。编码器逐帧分析量化强度，为每帧分配一个量化值。

`--crf`

<浮点范围 0\~51，默认 23>据 cplxBlur，cutree，B 帧偏移给每帧分配各自量化强度的固定目标质量模式。素材级画质设在 16\~18，收藏\~高压画质设在 19\~20.5，YouTube 是 23

#### ABR 模式（average bitrate）

在压制的不可能三角中实现“体积和速度优先，忽略画质”的平均码率率控制模式，如果故意提供较高码率（如 1920x1080\@30 下设置 50Mbps），则成为一种近无损模式。

`--bitrate`

<整数 kbps>平均码率。若视频易压缩且码率给高，就会得到码率比设定的片子；反过来低了会不照顾画质强行提高量化，使码率达标。一般推流用的“码率选项”就是设置了这个参数

#### CQP 模式

在压制的不可能三角中实现“速度绝对优先，忽略其它”的“无率控制”模式

`--qp`

<整数 0\~69，禁用 CRF/ABR/模式决策/率失真优化>设定全局量化强度。除非有既定目的，否则不建议使用。如果要手动指定特定范围的帧类型和量化值，则应使用 SBRC 下层模式

#### Zones 分段模式

点击展开/折叠内容

手动指定帧数片段，每个片段允许指定一种上层模式和一些控制参数。

`--zones`

<开始帧，结束帧，参数 A，参数 B…> 手动在视频中划区，采用不同上层模式来实现如提高压制速度，节省平均码率，提高特定画面码率等用途 (一般用来"处理"片尾滚动字幕). zones 内的 me, merange 强度/大小不能超 zones 外。可用参数有 b=, q=, crf=, ref=, scenecut=, deblock=, psy-rd=, deadzone-intra=, deadzone-inter=, direct=, me=, merange=, subme=, trellis=

1. 参数 b= 调整码率比率，限制 `--zones` 内的场景使用当前 0\~99999% 的码率，100% 相当于不变
2. 参数 q= 即 CQP 模式的 `--qp` 参数

### 2pass 模式

先用 CRF 模式分析整个视频总结可压缩信息，后根据 ABR 模式的码率限制统一分配量化值。有 pass 2 给特别高的平均码率，输出最小损失的最小体积近无损模式，以及 pass2 给码率硬限的全局整体压缩模式

`--pass 1`

<挡位，导出 stats 数据文件>

`--pass 2`

<挡位，导入 stats 数据文件>

`--stats`

<路径，默认在 x264/5 所在目录下>设定导出和导入 stats 数据文件的路径和文件名

### VBR，CBR 模式

带宽是有限资源。一旦网络、硬盘、内存、PCIE 等等带宽慢于当前视频码率，播放就会卡顿。因此在播放流媒体前，播放器会设置一段内存缓冲区，利用了传输速度有时会快于当前视频码率的随机条件，预加载一些数据以求播放不卡顿。此时问题变成了“缸里一端加水（进入缓存）、另一端放水（放出缓存），注水量变化但确保缸里一直有水，求缸的大小”。如此，只要平均传输带宽大于 GOP 平均码率则播放流畅。有的大型 3D 游戏中没有加载缓冲区，导致无论电脑内存多大，只要玩家移动到触发地图加载的区域后，游戏才会开始读盘而突然卡顿。

#### 基于缓冲区的量化控制（Video Buffer Verifier、VBV）

1. 保证 `rc-lookahead` 范围内，用户通过 `--vbv-bufsize --vbv-maxrate` 指定网络/设备元器件带宽所能及的缓冲速度是否大于等于码率流量
2. 码率超过缓冲区域则视频必然会卡顿，所以加大视频中「码率大于带宽处」的压缩强度。因此 VBV 对画质的破坏较大
3. 与 CRF 上层模式一并使用时叫可变码率 Variable BitRate（VBR），或 Capped-CRF 模式
4. 与 ABR 上层模式一并使用时叫固定码率 Constant BitRate（CBR），或 Capped-ABR 模式

`--vbv-bufsize`

<整整数 kbps，默认关（0），需小于 `--vbv-maxrate`>在编码器解码出原画后，每秒最多可占的缓存。bufsize÷maxrate=播放时解码出每 gop 原画帧数的缓冲用时（秒）。

`--vbv-maxrate`

<整数 kbps，默认关 0>峰值红线。用出缓帧码率减去入缓帧的码率必须小于等于 maxrate，从而限制编码器在 GOP 码率超 bufsize，即缓存跑满时压缩超载帧（提高量化强度 + 强降噪至码率合规为止）。当入缓帧较小时，出缓帧就算超 maxrate 也会因缓存有空而不被压缩。所以有四种状态，需经验判断：

- 大：GOP 大小=bufsize=2×maxrate，视频码率超出 maxrate 后等缓存满再压缩，避开多数涨落，适合限平均率的串流
- 小：GOP 大小=bufsize=1×maxrate，视频码率超出 maxrate 后直接压缩，避开部分涨落，适合限峰值的串流
- 超：GOP 大小\<bufsize=1\~2×maxrate，视频码率超出 maxrate 后直接压缩，但因视频小/crf 大所以作用不大
- 欠：GOP 大小>bufsize=1\~2×maxrate，视频码率超出 maxrate 后直接压缩，但因视频大/crf 小所以全都糊掉

由于 gop 多样，4 种状态可以出现在同一视频中。buf/max 实际控制了这些状态的出现概率

`--nal-hrd`

<开关，默认关，需 VBV>开启假想对照解码器 Hypothetical reference decoder。与假想播放流程中得到额外的 VBV 控制信息，并写进每段序列参数集 sps 及辅助优化信息 sei 里，适合提高 VBV 控制精度

`--ratetol`

<浮点百分比，默认 1> maxrate 限码的容错程度，用于防止压缩过大，但与此同时码率过大所导致卡顿的次数会增加

### 下层——FTQP 模式

手动通过文件制定帧类型和量化强度。

`--qpfile`

<路径到文件>手动指定帧类型和量化强度 closed-gop 下 K 帧的 frame type 量化强度下层模式。qpfile 文件内的格式为"帧号 帧类型 QP"

- 帧类型可以选 \[I,i,K,P,B,b]
- 大写 B 代表 B-Pyramid
- 大写 I 代表 IDR 帧
- K 在 `--no-open-gop` 时代表 IDR 帧
- K 在 `--open-gop` 时代表 i 帧
- x265 中，量化强度（QP 值）可以不填，代表使用上层率控制模式
- x264 中，量化强度（QP 值）填-1 代表使用上层率控制模式

qpfile.txt 例：

- 0 I 18
- 1 P 20
- 2 B 22
- 3 i 21
- 4 b 28

### 其它率控制

可以搭配除 CQP 以外的上下层模式使用，决定了视频各处的最终量化值

`--qpmin`

<整数 0\~51>由于画质和优质参考帧呈正比，所以仅高压环境建议设最高 14

`--qpmax`

<整数 0\~51>在要用到颜色键，颜色替换等需要清晰物件边缘的滤镜时，可以设26防止录屏时物件的边缘被压缩的太厉害，其他情况永远不如关 `--cutree/--mbtree`

`--chroma-qp-offset`

<整数，默认 0>AVC 规定 CbCr 的码率之和应等于 Y 平面，所以 x264 会拉高色度平面的量化。

- 使用 `--psy-rd` 后，x264 会自动设定 -2\~-4。
- 不用 `--psy-rd` 时，动漫或幻灯片录屏片源的 4:2:0 视频可手动设 -2\~-4
- 编码 YCbCr 4:4:4 时，x264 会自动设定 -2\~-4。

`--slow-firstpass`

<开关>pass1 里自动关闭以下提速，或自动提高以下参数的强度，以保证 pass1 模式中 CRF 模式计算量化值的准确度：`--no-8x8dct --me dia --partitions none ref 1 --subme <=2 --trellis 0 --fast-pskip`，可手动覆盖为强度更高的参数
