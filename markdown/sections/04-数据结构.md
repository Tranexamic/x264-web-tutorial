## 数据结构

### 帧的结构

在 Advanced Video Coding AVC 中，帧的下级结构按照分辨率大小分为条带组 → 条带 → 宏块 → 块 / Slice group → Slice → Macroblock → Block。从大小和功能上细分为：

- **帧（Frame）**：

  - **关键帧**：I/i 帧
  - **参考帧**：P 帧、B/b 帧

- **条带组（Slice group）**：

  - 由灵活宏块排序 Flexible Macroblock Ordering FMO 划分
  - 优化解码延迟，提高压缩和参考错误恢复能力

- **条带（Slice）**：

  - **关键帧下**：I/i 条带
  - **参考帧下**：I/i 条带、P 条带、B/b 条带
  - 空条带：填充网络数据包中，数据不足而无法填满的空位
  - 冗余条带：提高数据抗丢包，抗损坏的能力

- **宏块（Macroblock）**：
  - 粗分块，在动态搜索与补偿前完成，面积为 16x16 像素

- **块（Block）**：

  - 细分块，在动态搜索与补偿后完成，面积为 8x8 或 4x4 像素
  - **关键帧下**：帧内预测块、帧间预测块
  - **参考帧下**：帧内预测块、帧间预测块、帧内残差块、帧间残差块
  - **帧间预测块**：将 I 块叠加帧间动态矢量后变出的帧间预测画面
  - **帧内预测块**：从块左侧和顶部的一排相邻像素上，叠加插值算法变出的帧内预测画面
  - **残差块**：保存帧间和帧内预测无法还原的信息，与预测宏块叠加用。画面复杂则“残差才是本体”

![Video-Coding-Components](files/basics/Video-Coding-Components.png)

### GOP 结构

而相对的，在帧之上的结构被称为图组 Group of pictures。每个 GOP 的创建取决于关键帧间隔设置以及转场判断，其中都包含了 IDR 帧，i 帧，P 帧，Pyramid-B 帧以及 b 帧。一个视频中最少由一个 GOP 组成，同视频长度下 GOP 的数量越多则视频体积越大，解码难度越低。

- **关键帧 IDR 帧，I 帧**：

  - **I 帧 Intra-coded frame**独立编码，不依赖于其他帧的关键帧。也可以作为解码的起始点，只是不会刷新参考帧列表，所以强行播放可能会有一些画面错误
    - “关键”代表“起到独立解码，随机访问点 Access point，传输错误后重新同步视频流，集中参考源以提高压缩率等关键作用”

  - **即时解码刷新 Instantaneous Decoder Refresh 帧**是一种带有刷新标记的特殊 I 帧，解码器播放到 IDR 帧时会刷新参考帧列表，因此 IDR 帧之前的帧不再作为参考源，从而隔离了 GOP。

  - IDR 帧一般位于 GOP（Group of Pictures）之首。用户拖动进度条时，解码器会寻找最近的 IDR 帧解码

  - IDR 帧与 I 帧同为关键帧，有时会被写作 I 帧与 i 帧

  - IDR 帧数量过少时，可能会导致以下问题：

    - 随机访问会导致参考错误 + 长时间无法纠正画面错误：P，B，b 帧会尝试参考 i 帧之前的帧
    - 剪辑困难：专业视频编辑软件会在剪辑视频时会插入新的 IDR 帧以保证预览流畅和准确
    - 随机访问困难，因为 GOP 的基础结构不存在，拖动进度条需要从视频开头解码到新的位置以后才能播放
    - 拖动进度条代表需要从很远的 IDR 帧（无 IDR 帧则从视频开头）解码到新的位置再继续，等待的时间变得漫长，播放设备的发热增加
    - 如果播放器关闭了拖动进度条的精确索引，则拖动进度条会导致进度条位置偏移到其之前很远的 IDR 帧上，或返回开头

  - 如果 I 帧数量过少，则会有一串含有 I 条带的 P 帧替代它

  - IDR 帧的数量由 Keyframe interval `--keyint` 参数和 `--scenecut` 参数决定

  - I 帧的数量由 `--min-keyint` 参数决定

- **参考帧 P/B/b 帧**：

  - 参考帧 P 帧 Prediction frame 含有 I 条带与 P 条带，全部条带都可以给临近的 P，B 帧参考
  - 双向参考帧 Bi-directional prediction frame，b 帧含有 i，P，B 条带，只有 i 条带可以给临近的 P，B 帧参考
  - 尖塔 B 帧 Pyramid bi-directional prediction frame 含有 I，P，B 条带，全部条带都可以给临近的 P，B 帧参考

#### 多参考帧的结构

x264 首次引入了超过前后一帧长度的帧间参考范围。因此动态搜索也能更好的检查运动向量的时间一致性，从而减少动态噪点对动态搜索的干扰，同时提高了压缩。多参考帧不是越长越好，而是只要满足「一帧只要参考前后各 N 帧的信息就足以还原自身」的长度就是最优解的，而超过后会导致视频体积增加，同时画质降低。这个长度一般是前后各 3 帧，即 `--ref 3`。
